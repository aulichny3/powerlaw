// Copyright (c) 2025 Adam Ulichny
//
// This source code is licensed under the MIT OR Apache-2.0 license
// that can be found in the LICENSE-MIT or LICENSE-APACHE files
// at the root of this source tree.

//! Test of the hypothesis that the sample data could have been generated by a Pareto process.
//! Function to hypothesis test the best fit params to m synthetic datasets. This is Section 4 of
//! Clauset, Aaron and Shalizi, Cosma Rohilla and Newman, M. E. J. [doi:10.48550/ARXIV.0706.1062](https://doi.org/10.48550/arXiv.0706.1062)
use super::estimation::find_alphas_fast;
use super::gof::{gof, ParetoFit};
use crate::util::sim::{self, SimParams};

/// Represents the results of a hypothesis test.
pub struct H0 {
    /// The number of synthetic datasets where the KS statistic was greater than the observed KS statistic.
    pub gt: usize,
    /// The total number of synthetic datasets generated.
    pub total: usize,
    /// The p-value of the hypothesis test, calculated as `gt / total`.
    pub pval: f64,
}

/// Performs a hypothesis test to determine if the data is plausibly drawn from a power-law distribution.
///
/// # Parameters
/// - `data`: A `Vec<f64>` representing the sample dataset to fit.
/// - `prec`: The desired precision of the p-value estimate. The number of simulations is calculated as `1/4 * prec^(-2)`.
/// - `alpha`: The `alpha` parameter of the proposed best fit.
/// - `x_min`: The `x_min` parameter of the proposed best fit.
/// - `best_d`: The Kolmogorov-Smirnov (KS) test statistic `D` from the best-fit `alpha`/`x_min` combination.
///
/// # Returns
/// An `H0` struct containing the results of the hypothesis test.
pub fn hypothesis_test(data: Vec<f64>, prec: f64, alpha: f64, x_min: f64, best_d: f64) -> H0 {
    // setup the simulation: number of sims, elements in each etc.
    let sim_params: SimParams = sim::calculate_sim_params(&prec, &data, &x_min);

    println!("Generating M = {:?} simulated datasets of length n = {:?} with tail size {:?} and probability of the tail P(tail|data) = {:?}", sim_params.num_sims_m, sim_params.sim_len_n, sim_params.n_tail, sim_params.p_tail);

    let S: Vec<Vec<f64>> = sim::generate_synthetic_datasets(&data, alpha, x_min, sim_params);
    let sim_size: usize = S.len();

    // loop through each sim and calculate the KS d value
    let mut sim_ds = vec![];

    for mut i in S {
        // Step 1: test finding the MLE alphas for a given range of x_min and the data
        let alphas: (Vec<f64>, Vec<f64>) = find_alphas_fast(&mut i);

        // Step 2: gof KS test the cdf of the proposed x_min and alpha hat vs the sample with x >= x_min.
        // this is to find the best x_min/alpha pair given the data
        let best_fit: ParetoFit = gof(&i, &alphas.0, &alphas.1);
        //println!("best fit {:?}", best_fit);
        sim_ds.push(best_fit.d);
        //println!("Best fit D {d}");
    }

    let gt = sim_ds.iter().filter(|&x| *x > best_d).count();
    //let n = final_sim.len();

    //let p = gt as f64 / n as f64;
    //println!("gt {gt} n {n} p is: {p}");

    let p_val = gt as f64 / sim_size as f64;
    //println!("gt {gt} n {sim_size} p is: {p}");
    //(gt, sim_size, p)
    H0 {
        gt,
        total: sim_size,
        pval: p_val,
    }
}
